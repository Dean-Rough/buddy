# Onda Authentication Flow Diagram

## Overview

This diagram shows the complete authentication flow for the Onda platform, including all entry points, routing logic, and final destinations.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                LANDING PAGE (/)                                 â”‚
â”‚                                                                                 â”‚
â”‚  Header:                           Hero Section:                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ LOGIN   â”‚ â”‚ SIGNUP  â”‚           â”‚ GET STARTED â”‚ â”‚ CHILD SIGN IN â”‚           â”‚
â”‚  â”‚(chat)   â”‚ â”‚(parent) â”‚           â”‚  (parent)   â”‚ â”‚    (chat)     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                                 â”‚
â”‚  Other CTAs: "TRY ONDA", "GET STARTED" â†’ (parent)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           useAuthFlow() ROUTING                                â”‚
â”‚                                                                                 â”‚
â”‚  if (!user && destination === 'parent'):                                       â”‚
â”‚  â”œâ”€â–º redirectToSignUp({ redirectUrl: "/onboarding?type=parent" })              â”‚
â”‚                                                                                 â”‚
â”‚  if (!user && destination === 'chat'):                                         â”‚
â”‚  â”œâ”€â–º router.push('/sign-in')                                                   â”‚
â”‚                                                                                 â”‚
â”‚  if (user && userType === 'parent'):                                           â”‚
â”‚  â”œâ”€â–º router.push('/parent')                                                    â”‚
â”‚                                                                                 â”‚
â”‚  if (user && userType === 'child'):                                            â”‚
â”‚  â”œâ”€â–º router.push('/chat')                                                      â”‚
â”‚                                                                                 â”‚
â”‚  if (user && !userType):                                                       â”‚
â”‚  â”œâ”€â–º router.push('/onboarding/setup')                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     PARENT SIGNUP FLOW      â”‚ â”‚      CHILD SIGNIN FLOW      â”‚
â”‚                             â”‚ â”‚                             â”‚
â”‚ /onboarding?type=parent     â”‚ â”‚ /sign-in                    â”‚
â”‚          â”‚                  â”‚ â”‚          â”‚                  â”‚
â”‚          â–¼                  â”‚ â”‚          â–¼                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚   Clerk SignUp Form     â”‚ â”‚ â”‚ â”‚   User Type Choice      â”‚ â”‚
â”‚ â”‚ â€¢ Email/Password        â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â€¢ Sets userType:parent  â”‚ â”‚ â”‚ â”‚ â”‚I'M A KIDâ”‚ â”‚I'M A    â”‚ â”‚ â”‚
â”‚ â”‚ â€¢ redirectUrl: /parent  â”‚ â”‚ â”‚ â”‚ â”‚         â”‚ â”‚PARENT   â”‚ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚          â”‚                  â”‚ â”‚ â”‚     â”‚           â”‚       â”‚ â”‚
â”‚          â–¼                  â”‚ â”‚ â”‚     â–¼           â–¼       â”‚ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚   PARENT DASHBOARD      â”‚ â”‚ â”‚ â”‚ â”‚ Child   â”‚ â”‚ Clerk   â”‚ â”‚ â”‚
â”‚ â”‚      (/parent)          â”‚ â”‚ â”‚ â”‚ â”‚SignIn   â”‚ â”‚SignIn   â”‚ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚Username â”‚ â”‚Email/   â”‚ â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚/PIN     â”‚ â”‚Password â”‚ â”‚ â”‚
                                â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
                                â”‚ â”‚     â”‚           â”‚       â”‚ â”‚
                                â”‚ â”‚     â–¼           â–¼       â”‚ â”‚
                                â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
                                â”‚ â”‚ â”‚  CHAT   â”‚ â”‚ PARENT  â”‚ â”‚ â”‚
                                â”‚ â”‚ â”‚ (/chat) â”‚ â”‚(/parent)â”‚ â”‚ â”‚
                                â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              MIDDLEWARE LAYER                                  â”‚
â”‚                         (Runs on every route change)                           â”‚
â”‚                                                                                 â”‚
â”‚ Check 1: User authenticated?                                                    â”‚
â”‚ â”œâ”€ NO: Allow access to public routes (/, /sign-in, /onboarding)               â”‚
â”‚ â”‚      Block access to protected routes â†’ redirect appropriately               â”‚
â”‚ â”‚                                                                             â”‚
â”‚ â””â”€ YES: Check userType metadata                                               â”‚
â”‚    â”‚                                                                           â”‚
â”‚    â”œâ”€ userType = 'parent':                                                     â”‚
â”‚    â”‚  â€¢ Accessing / or /sign-in â†’ redirect to /parent                         â”‚
â”‚    â”‚  â€¢ Accessing /onboarding â†’ redirect to /parent                           â”‚
â”‚    â”‚  â€¢ Allow /parent access                                                   â”‚
â”‚    â”‚                                                                           â”‚
â”‚    â”œâ”€ userType = 'child':                                                      â”‚
â”‚    â”‚  â€¢ Not accessing /chat â†’ redirect to /chat                               â”‚
â”‚    â”‚  â€¢ Allow /chat access                                                     â”‚
â”‚    â”‚                                                                           â”‚
â”‚    â””â”€ No userType (legacy/incomplete):                                         â”‚
â”‚       â€¢ Allow /onboarding/setup access                                         â”‚
â”‚       â€¢ /sign-in â†’ redirect to /onboarding/setup                              â”‚
â”‚       â€¢ Root path (/) â†’ allow (can complete onboarding)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            EDGE CASE HANDLING                                  â”‚
â”‚                                                                                 â”‚
â”‚ /onboarding/setup (User Type Selection):                                       â”‚
â”‚ â”œâ”€ "I'M A PARENT" â†’ sets userType:parent â†’ redirect to /parent                â”‚
â”‚ â””â”€ "I'M A KID" â†’ sets userType:child â†’ redirect to /chat                      â”‚
â”‚                                                                                 â”‚
â”‚ AuthGuard Component (on protected pages):                                      â”‚
â”‚ â”œâ”€ No user â†’ redirect to /                                                     â”‚
â”‚ â”œâ”€ No userType â†’ redirect to /onboarding/setup                                â”‚
â”‚ â”œâ”€ Wrong userType â†’ redirect to appropriate page                               â”‚
â”‚ â””â”€ Correct userType â†’ render protected content                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FINAL DESTINATIONS                                â”‚
â”‚                                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚ â”‚  PARENT DASHBOARDâ”‚  â”‚    CHAT APP     â”‚  â”‚  USER SETUP     â”‚                â”‚
â”‚ â”‚    (/parent)    â”‚  â”‚    (/chat)      â”‚  â”‚(/onboarding/    â”‚                â”‚
â”‚ â”‚                 â”‚  â”‚                 â”‚  â”‚    setup)       â”‚                â”‚
â”‚ â”‚ â€¢ Child account â”‚  â”‚ â€¢ AI chat       â”‚  â”‚ â€¢ Choose user   â”‚                â”‚
â”‚ â”‚   management    â”‚  â”‚ â€¢ Safety        â”‚  â”‚   type (edge    â”‚                â”‚
â”‚ â”‚ â€¢ Safety alerts â”‚  â”‚   monitoring    â”‚  â”‚   case only)    â”‚                â”‚
â”‚ â”‚ â€¢ Settings      â”‚  â”‚ â€¢ Voice input   â”‚  â”‚                 â”‚                â”‚
â”‚ â”‚ â€¢ Data download â”‚  â”‚ â€¢ Personas      â”‚  â”‚                 â”‚                â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Features

### ğŸ¯ **Simplified Entry Points**

- **Primary CTA buttons** â†’ Parent signup flow
- **Child Sign In** â†’ Child authentication flow
- **Header Login** â†’ Flexible sign-in (user chooses type)

### ğŸ”„ **Smart Routing**

- **useAuthFlow()** determines destination based on user intent
- **Middleware** enforces proper routing based on authentication status
- **AuthGuard** protects individual pages with type-specific access

### ğŸ›¡ï¸ **Safety & Compliance**

- **Parent metadata** set automatically during signup
- **COPPA compliant** child account creation
- **Dual authentication** (PIN for children, email/password for parents)

### ğŸ”§ **Error Recovery**

- **Missing userType** â†’ Guided setup flow
- **Wrong user type** â†’ Automatic redirection
- **Unauthenticated access** â†’ Appropriate sign-in flow

## Implementation Notes

1. **All main CTAs** lead to parent signup for business conversion
2. **Child access** is clearly separated but easily accessible
3. **Middleware handles edge cases** automatically
4. **No confusing double user type selection** (previous issue resolved)
5. **Clear separation** between parent and child experiences
